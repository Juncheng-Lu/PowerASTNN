## Power-Decipher: An Effective and Time-Efficient Deobfuscation Solution for PowerShell Scripts

### User Guide for Power-Decipher

#### 1.Runtime Environment
**It is recommended to use this tool in a virtual machine.**
+ Systemï¼šWindows 10 
+ PowerShell 5.1
+ Python 3.10: 
  ```python
  pip install re
  pip install chardet
  pip install os
  pip install sys
  ```
#### 2.Download the tool
**Note: The tool's path must be in English only.**
```git clone https://github.com/```

#### 3.Install AMSI-Recorder
+ Place `Amsi_Recorder.dll` in the `C:\` directory.
+ Run `cmd` as an administrator and enter:
    ```
    cd C:\
    regsvr32.exe Amsi_Recorder.dll
    ```

#### 4.Tool Usage Instructions
+ Folder Description: There are 4 folders, each storing the deobfuscated files for different stages.
  ```
    Obfuscated_File    #Obfuscated Script Folder (Place the files that need to be deobfuscated here)
    Deobfuscated_AMSI # Stores the results of the first stage of deobfuscation
    fasttext_replace # Stores the replacement word list for the second stage of deobfuscation
    final_output # Stores the final script output
  ```
+ Run the tool, open PowerShell, and navigate to the directory where Power-Decipher is located:
  ```powershell
    ./Power-Decipher.ps1
  ```

#### 5.Usage Example

###### Obfuscated Source Code:
```PowerShell
# 3 laylers: echo "Amsiutils1" -> string -> encoding -> string

sV dVs  (  [CHar[ ] ]")''niOj-]52,51,4[cEPsmOC:VnE$ ( &|)93]RAHC[]gniRTS[,'f6b'(ECaLPer.)'|',)711]RAHC[+75]RAHC[+15]RAHC[((ECaLPer.)63]RAHC[]gniRTS[,)711]RAHC[+55]RAHC[+511]RAHC[((ECaLPer.)')'+' '+'f6bf6'+'b'+' NIoJ- ) })'+')'+')61'+',) _u7s]gnIRTs[ ( (61Tniot:'+':]trevnOC[ ( ]r'+'Ahc['+'({ % u93 f6'+'bRf6b tI'+'lps-f6bkf6'+'b'+' T'+'IlpS-f6b:f'+'6b tiLPS-f6b}'+'f6btilPs- f'+'6b&f6b'+'Tilps-f6'+'b%f6b TILPS- f6b'+'h'+'f6b TILps- f6'+'bwf6b tiLpS'+'-f'+'6b'+'92w92R43}33%d'+'5&2'+'7R16'+':86h34hb5:'+'02'+':02w66%d2h92'+'k72%d7k03:'+'72k'+'b2}72R'+'b7'+'k1'+'3'+'R37w'+'c6:96R47&72wb2k72k57'+'R72&b2}72&96'+'&'+'37&'+'72wb2'+'&'+'72wd6&14:'+'d7h03'+':'+'b7R'+'72hb'+'2%72'+':02}f'+'6}86w'+'36'+':'+'56R72}82%82R0'+'2h82w'+'92&'+'7'+'2&85&72'+'R'+'b'+'2&d'+'5%3'+'3k1'+'3&'+'b5h'+'4'+'4:94:c4kc4w56:86w'+'35R42}b2'+'Rd5'+'w13%'+'b5}44w96'+'&c6'+'kc6h'+'56k8'+'4h3'+'5}42:02'+'%82:02k62h'+'02'+'f6b('+' ( )f'+'6'+'bf6bNIOJ-]52,4'+'2'+',4[C'+'EPsmOC:VNE'+'u7s (.'(") ;  [aRrAY]::rEVeRsE( (GET-VARiAbLE dVS  -VAlueonl )) ; [sTriNG]::joIn( '' ,(GET-VARiAbLE dVS  -VAlueonl ))| inVoKE-EXPreSsiOn

# 2layers split
('-=_'|%{  ${;}  =+  $(  )}  {  ${'@}  =${;}  }{${%}=++${;}}  {${*' }  =(${;}=${;}+  ${%})}  {  ${$}=  (  ${;}=  ${;}  +${%})  }  {  ${]}=(  ${;}=  ${;}  +  ${%}  )}  {  ${ =.}  =(${;}  =  ${;}  +${%}  )}{  ${.#}  =(${;}=  ${;}+${%}  )  }  {${+}  =  (${;}  =  ${;}  +${%}  )}{  ${';}=(${;}=  ${;}  +  ${%}  )}{${)}=  (  ${;}  =${;}+${%}  )  }  {${~.$}=  "["  +"$(  @{}  )"[${+}]  +"$(@{  })"["${%}"  +  "${)}"  ]  +  "$(@{  })  "[  "${*' }"+"${'@}"]  +  "$?"[  ${%}  ]+  "]"  }{${;}="".("$(  @{  })"[  "${%}${]}"  ]  +  "$(  @{  }  )"["${%}${.#}"]  +  "$(@{})"[${'@}  ]  +  "$(  @{}  )  "[  ${]}]+  "$?"[${%}  ]+  "$(@{}  )  "[${$}  ])  }{${;}  ="$(  @{  }  )"["${%}"+  "${]}"]  +  "$(  @{  }  )"[  ${]}  ]+  "${;}"["${*' }"  +"${+}"]  }  );.  ${;}  ("${;}(  ${~.$}${$}${';}+${~.$}${]}${'@}+  ${~.$}${$}${*' }  +${~.$}${$}${.#}+  ${~.$}${%}${%}${ =.}+${~.$}${%}${'@}${]}  +${~.$}${%}${'@}${%}+${~.$}${%}${'@}${';}+  ${~.$}${%}${'@}${';}+${~.$}${%}${'@}${ =.}+${~.$}${.#}${';}  +  ${~.$}${)}${%}+  ${~.$}${]}${)}  +${~.$}${)}${$}  +  ${~.$}${]}${$}  +${~.$}${$}${.#}  +  ${~.$}${%}${%}${ =.}  +  ${~.$}${+}${*' }+  ${~.$}${%}${'@}${%}+  ${~.$}${+}${.#}  +  ${~.$}${%}${'@}${';}+  ${~.$}${%}${'@}${ =.}+  ${~.$}${.#}${';}+${~.$}${)}${%}+  ${~.$}${]}${)}  +${~.$}${ =.}${%}  +  ${~.$}${)}${$}  +  ${~.$}${]}${$}  +  ${~.$}${$}${)}+${~.$}${';}${';}+${~.$}${$}${)}+${~.$}${]}${%}+  ${~.$}${$}${*' }  +${~.$}${]}${'@}+${~.$}${]}${'@}  +  ${~.$}${]}${'@}  +${~.$}${$}${]}+${~.$}${%}${*' }${$}  +  ${~.$}${]}${)}+${~.$}${%}${*' }${ =.}+  ${~.$}${%}${*' }${$}  +  ${~.$}${ =.}${*' }  +  ${~.$}${%}${*' }${ =.}  +${~.$}${%}${*' }${$}  +  ${~.$}${ =.}${%}  +  ${~.$}${%}${*' }${ =.}  +${~.$}${%}${*' }${$}+  ${~.$}${ =.}${'@}  +${~.$}${%}${*' }${ =.}  +${~.$}${%}${*' }${$}  +${~.$}${]}${';}  +  ${~.$}${%}${*' }${ =.}+${~.$}${$}${]}  +${~.$}${$}${*' }+${~.$}${]}${ =.}+  ${~.$}${%}${'@}${*' }+  ${~.$}${$}${)}+${~.$}${ =.}${'@}+  ${~.$}${ =.}${%}+${~.$}${+}${%}+${~.$}${ =.}${.#}+  ${~.$}${$}${)}+${~.$}${]}${]}+${~.$}${$}${)}  +${~.$}${%}${'@}${%}+${~.$}${)}${)}+${~.$}${%}${'@}${]}  +${~.$}${%}${%}${%}  +${~.$}${$}${*' }  +  ${~.$}${ =.}${%}  +  ${~.$}${+}${%}  +${~.$}${ =.}${.#}+  ${~.$}${.#}${ =.}  +${~.$}${%}${'@}${)}+  ${~.$}${%}${%}${ =.}+${~.$}${$}${)}  +${~.$}${]}${]}+  ${~.$}${$}${)}+  ${~.$}${%}${'@}${ =.}  +${~.$}${%}${'@}${';}+  ${~.$}${%}${%}${ =.}+${~.$}${$}${)}  +  ${~.$}${]}${]}+${~.$}${$}${)}+${~.$}${%}${%}${+}+${~.$}${%}${%}${.#}  +${~.$}${$}${)}  +  ${~.$}${]}${]}+  ${~.$}${$}${)}  +${~.$}${%}${'@}${ =.}+  ${~.$}${$}${)}+  ${~.$}${]}${%}+${~.$}${]}${%}+${~.$}${]}${.#}+  ${~.$}${%}${%}${]}  +${~.$}${%}${'@}${%}  +${~.$}${%}${%}${*' }+  ${~.$}${%}${'@}${';}+  ${~.$}${)}${+}  +${~.$}${.#}${+}+  ${~.$}${.#}${)}+  ${~.$}${]}${'@}  +${~.$}${$}${)}+  ${~.$}${ =.}${%}  +${~.$}${+}${%}  +  ${~.$}${ =.}${.#}  +  ${~.$}${$}${)}  +${~.$}${]}${]}+${~.$}${)}${%}+  ${~.$}${';}${$}+  ${~.$}${%}${%}${.#}+${~.$}${';}${*' }  +${~.$}${%}${'@}${ =.}+${~.$}${%}${%}${'@}+${~.$}${+}${%}  +  ${~.$}${)}${$}  +${~.$}${)}${%}+${~.$}${.#}${+}  +  ${~.$}${%}${'@}${]}  +${~.$}${.#}${ =.}  +  ${~.$}${%}${%}${]}  +${~.$}${)}${$}  +${~.$}${ =.}${%}  +${~.$}${ =.}${*' }+${~.$}${]}${%}+${~.$}${$}${*' }+  ${~.$}${]}${%}+${~.$}${$}${*' }+${~.$}${%}${$}  +${~.$}${%}${'@}  +${~.$}${%}${'@}${%}  +${~.$}${)}${)}+  ${~.$}${%}${'@}${]}  +  ${~.$}${%}${%}${%}  +${~.$}${$}${*' }  +${~.$}${$}${]}  +  ${~.$}${%}${%}${.#}+${~.$}${%}${'@}${]}+${~.$}${%}${'@}${ =.}+${~.$}${%}${%}${ =.}+  ${~.$}${$}${*' }  +${~.$}${%}${'@}${ =.}+${~.$}${%}${%}${ =.}+${~.$}${$}${*' }  +${~.$}${%}${%}${ =.}+${~.$}${%}${%}${%}  +  ${~.$}${%}${'@}${)}+${~.$}${%}${'@}${%}+  ${~.$}${%}${%}${.#}+  ${~.$}${%}${'@}${]}+${~.$}${%}${'@}${ =.}  +${~.$}${%}${%}${'@}+${~.$}${%}${'@}${$}  +  ${~.$}${$}${*' }  +  ${~.$}${)}${)}  +  ${~.$}${%}${'@}${';}+${~.$}${%}${'@}${%}+  ${~.$}${)}${+}+${~.$}${%}${%}${]}+  ${~.$}${$}${*' }  +${~.$}${)}${)}+  ${~.$}${%}${%}${%}  +  ${~.$}${%}${'@}${'@}  +  ${~.$}${%}${'@}${%}+${~.$}${$}${]})")  

#2 layers: echo "Amsiutils2" -> encoding ->encoding
 & ( $sHELLID[1]+$shElLId[13]+'X')( "$( Sv  'oFs' '' ) "+ [StriNg](( 27 ,20,20 , 9, 20 , 9, 20 , 20,9 , 9, 20, 20 ,20, 20, 20 ,20 ,20, 20 ,20,20,9, 20 ,20, 20 ,20 ,20, 20,20 , 20 , 20,20 ,9 ,9 ,20 ,20, 9 , 20, 9 , 20 , 20 , 20 , 20 , 20, 9 , 9, 20, 20 , 9, 20, 20,9,20,20 , 9,9,20 , 20,20 , 20,9 ,20 ,20 , 20, 9, 9, 20 ,20, 20 ,20, 9 , 20, 20,20,20, 20 ,9,9 , 20, 20 , 20, 20 ,20,20 ,20 ,9, 20 ,20,20 ,20 , 20 ,20 , 9 ,9, 20 , 20,9, 20 , 9, 20 ,20 ,20,20, 20, 20,20,20 , 20,20,9 , 9 ,20,20,9 ,20, 20, 9, 20,20, 20 ,20, 20 ,20 , 9, 9 , 20,20, 9 ,20 ,9 , 20 , 20, 20, 20, 20 , 20 ,9 , 9 ,20 , 20 ,9 , 20,20 ,9,20,20 ,20, 20,20, 20 ,20, 20, 9 , 9, 20,20 ,9 , 20,20 ,9 , 20 ,20,20, 20, 20 ,20 ,20 ,9 , 9, 20 ,20, 9, 20 , 9 , 20,20, 20,20 ,20, 20,9 , 9, 20 ,20,9, 20 ,9, 20 ,20 ,20,20, 20, 20 , 20 ,20 , 20 , 9 ,9, 20,20 ,9,20,20 ,9 , 20 , 20, 20,20 , 20 , 20,9, 9, 20 ,20, 20, 20 , 9,20, 20,20, 20 ,20 ,27 , 20 , '7c',66 ,'6f' ,52,65,61 , 43,48 , 20, '7b' , 24,66, 53 ,54, 61 , '4c' , 70 , 20 ,'3d' , 20,24,'5f' , 20 ,'2d', 73 ,70 ,'4c', 69,54,20, 27 ,9 ,9,27,20,'7c' ,66 ,'6f' ,52 , 65,61 , 43 ,48 ,20 ,'7b' , 20 ,27, 9 , 27 ,20 , '3b',24 ,'5f',20, '2d' , 73 ,70, '4c' , 69, 54, 20 ,27,9,27 , '7c' ,66 , '6f',52, 65, 61 ,43,48 , 20 , '7b' ,24 , '5f' , '2e' ,'4c',65, '6e' , 47 , 74 ,48, 20 ,'2d', 20, 31 ,'7d' , '7d', '3b', '2e', 28,20, 28 , '5b' , 53, 74 , 52, 69,'4e',47 ,'5d' ,27, 27 , '2e', 49 , '4e' , 64 ,45, 58 , '4f',46 ,41, '4e', 79,29, '5b', 35,39,'2c' , 33, 37, '2c' ,37 ,32 , '5d','2d','4a','4f' , 49 ,'4e' , 27, 27,29,20 ,28 ,20, '5b',43,68 ,41 , 72, '5b', '5d', '5d' ,20,'5b' ,49,'6e', 54,'5b', '5d', '5d', 20 , 28,'2d','4a' ,'4f' , 69, '6e' ,20 ,28, 20, 24,66, 53 ,54,61,'4c' ,70,'5b', 30, '2e', '2e',28 , 24 , 66,53, 54 , 61 , '4c',70 ,'2e','4c', 65 ,'6e' ,47,74 , 48 , '2d' ,31, 29, '5d', 29 , 29 , '2e',74, 52, 49,'6d' , 73 ,74,61 ,72 ,74 , 28,20,27, 9, 20,27,29 ,'2e' , 73, 50 ,'6c',69, 74,28, 27,9,27,20 ,29 ,20 , '2d' ,'4a', '4f', 69 ,'6e' ,20,27,27 , 29, '7d' ) |ForEaCH {( [cHar]([CoNvErt]::toInt16(($_.TOsTRinG() ) ,16)))} )+"$( Set-vaRiaBlE  'Ofs'  ' ' )" ) 


#3 hiding in variables
$i = (((("{6}{1}{3}{5}{4}{0}{2}"-f 'ils','ho','3{0}',' {0}Amsi','t','u','ec')) -F [char]34))
IEX $i

echo "Amsiutils5"

```
##### Result

```powershell
# 3 laylers: echo "Amsiutils1" -> string -> encoding -> string

echo "Amsiutils1"

# 2layers split
echo "Amsiutils2" 

#2 layers: echo "Amsiutils2" -> encoding ->encoding
 echo "Amsiutils" 


#3 hiding in variables
$i = echo "Amsiutils3"
echo "Amsiutils3"

echo "Amsiutils5"
```

